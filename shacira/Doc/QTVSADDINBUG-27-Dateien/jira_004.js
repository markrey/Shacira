AJS.Shortener=Class.extend({_getDefaultOptions:function(){return{items:"a, span",numRows:1,shortenText:"hide",shortenOnInit:true,persist:true}},init:function(options){var instance=this;if(typeof options==="string"){options={element:options}}options=options||{};this.options=AJS.$.extend(this._getDefaultOptions(),options);this.$container=AJS.$(this.options.element);jQuery("body").bind("tabSelect",function(){instance._ready()});this._ready()},_ready:function(){var instance=this,timer=null;if(!this.initialized&&this.$container.is(":visible")){this.$container.css({padding:0,display:"block"});if(this._isShortenedOnLoad()){this.shorten()}else{this.expand()}AJS.$(window).resize(function(){if(!instance.expanded&&timer===null){instance.timer=setTimeout(function(){instance.shorten();instance.timer=null},100)}});this.initialized=true}},_isShortenedOnLoad:function(){var cookieValue=localStorage.getItem("shorten-"+this.$container.attr("id"));if(cookieValue==="hidden"){return true}else{if(cookieValue==="shown"){return false}else{if(this.options.shortenOnInit){return true}}}return false},_renders:{ellipsis:function(itemsHidden){return AJS.$("<a href='#' class='ellipsis'>("+(itemsHidden)+")</a><br />")},shortenTip:function(removeText){return AJS.$("<a title='Hide' class='icon icon-hide' href='#'><span>"+removeText+"</span></a>")}},_removeEllipsis:function(){if(this.$ellipsis){this.$ellipsis.remove();this.$ellipsis=null}},_hasEllipsisWrapped:function(){return this.$ellipsis.attr("offsetTop")>this.$ellipsis.prev().attr("offsetTop")},_insertEllipsis:function(tryInsertAfter,itemsHidden){var that=this,insertAfterCount=tryInsertAfter;this.$ellipsis=this._renders.ellipsis(itemsHidden).insertAfter(this.$items[insertAfterCount]);if(insertAfterCount!==0&&this._hasEllipsisWrapped()){insertAfterCount--;that._removeEllipsis();that.$ellipsis=that._renders.ellipsis(itemsHidden+1).insertAfter(this.$items[insertAfterCount])}this.$ellipsis.click(function(e){e.preventDefault();that.expand()});return insertAfterCount},shorten:function(moveToShortened){function hasWrapped(){if(i<that.$items.length-1){return that.$items[i].offsetTop<that.$items[i+1].offsetTop||that.$items[i].offsetLeft>that.$items[i+1].offsetLeft||that.$items[i].realHeight>that.$items[i+1].realHeight+5}else{return that.$items[i].offsetTop>that.$items[i-1].offsetTop||that.$items[i].offsetLeft<that.$items[i-1].offsetLeft||that.$items[i].realHeight>that.$items[i-1].realHeight+5}}var availableRows=this.options.numRows,i=0,rows=0,containerheight=0,ellipseIndex=0,that=this;this._removeEllipsis();if(this.$shortenTip){this.$shortenTip.remove()}this.$items=this.$container.children(this.options.items);this.$items.each(function(){if(this.offsetHeight!==0){this.realHeight=this.offsetHeight}else{this.realHeight=AJS.$(this).children(that.options.items).attr("offsetHeight")||0}});if(this.$items.length<2){return }this.$container.css({overflow:"hidden"});do{if(hasWrapped()){rows++;if(rows===availableRows){if(i===0){ellipseIndex=that._insertEllipsis(0,this.$items.length-1)}else{ellipseIndex=that._insertEllipsis(i-1,this.$items.length-i)}containerheight=(this.$items[ellipseIndex].offsetTop-that.$items[0].offsetTop);containerheight+=this.$items[ellipseIndex].realHeight;if((that.$items[ellipseIndex].offsetTop)<this.$ellipsis[0].offsetTop){containerheight+=this.$ellipsis[0].offsetHeight+(this.$ellipsis[0].offsetTop-that.$items[ellipseIndex].offsetTop-this.$items[ellipseIndex].realHeight)}that.$container.height(containerheight+3);break}else{if(i===0){availableRows=availableRows+1}}}i++}while(this.$items[i]);if(this.options.persist){localStorage.setItem("shorten-"+this.$container.attr("id"),"hidden")}if(moveToShortened){this.$container.scrollIntoView()}if(jQuery.browser.msie&&jQuery.browser.version>=8&&jQuery.browser.version<9){AJS.$("body").addClass("reflow")}delete this.expanded},expand:function(){function canBeShortened(){return that.$items[0].offsetTop<that.$items[that.$items.length-1].offsetTop||(that.$items[0].realHeight*2)<that.$container[0].offsetHeight}var that=this;this.expanded=true;this._removeEllipsis();this.$items=AJS.$(this.$container.children(this.options.items));this.$items.each(function(){if(this.offsetHeight!==0){this.realHeight=this.offsetHeight}else{this.realHeight=AJS.$(this).children(that.options.items)[0].offsetHeight}});this.$container.css({height:"",overflow:""});if(this.$items.length>1&&canBeShortened()){this.$shortenTip=this._renders.shortenTip(this.options.shortenText);this.$shortenTip.appendTo(this.$container).click(function(e){that.shorten(true);e.preventDefault()})}if(this.options.persist){localStorage.setItem("shorten-"+this.$container.attr("id"),"shown")}if(jQuery.browser.msie){AJS.$("body").addClass("reflow")}}});jQuery.fn.shorten=function(options){var res=[];options=options||{};this.each(function(){options.element=this;res.push(new AJS.Shortener(options))});return res};
JIRA.bind(JIRA.Events.NEW_CONTENT_ADDED,function(e,$ctx){if($ctx.is(".js-stalker")){$ctx.stalker()}else{AJS.$(".js-stalker",$ctx).stalker()}});
JIRA.bind(JIRA.Events.NEW_CONTENT_ADDED,function(e,$ctx){AJS.$(".shorten",$ctx).shorten()});
JIRA.bind(JIRA.Events.NEW_CONTENT_ADDED,function(e,$ctx){AJS.Dropdown.create({trigger:AJS.$(".mod-header .aui-dropdown-trigger",$ctx)})});
AJS.$(function(){new JIRA.ToggleBlock({blockSelector:".toggle-wrap",triggerSelector:".mod-header h3",storageCollectionName:"block-states",originalTargetIgnoreSelector:"a"})});
(function($){function initGallery($el){var closeFancyBox=function(){$el.fancybox.close()};var isFireFoxLinux=function(){return $.os.linux&&$.browser.mozilla};var useOverlay=true;if(isFireFoxLinux()){useOverlay=false}var fancyBoxOptions={"imageScale":true,"centerOnScroll":false,"overlayShow":useOverlay,callbackOnStart:function(){$("#header").css("zIndex","-1");if(useOverlay){$("body").addClass("fancybox-show")}},"callbackOnShow":function(){$(document).click(function(){closeFancyBox()})},"onComplete":function(){var title=$("#fancybox-title");var mainWidth=$("#fancybox-title-main").outerWidth();var leftWidth=$("#fancybox-title-left").outerWidth();var rightWidth=$("#fancybox-title-right").outerWidth();title.width(mainWidth+leftWidth+rightWidth+5);var imageDivWidth=$("#fancybox-inner").width();title.css("marginLeft",-(title.width()/2)+(imageDivWidth/2));title.css("bottom",title.outerHeight(true)*-1)},"callbackOnClose":function(){$("#header").css("zIndex","");if(useOverlay){$("body").removeClass("fancybox-show")}$(document).unbind("click",closeFancyBox);if($.browser.safari){var top=$(window).scrollTop();$(window).scrollTop(10+5*(top==10)).scrollTop(top)}}};if($.browser.msie){fancyBoxOptions.transitionIn="none";fancyBoxOptions.transitionOut="none"}$el.fancybox(fancyBoxOptions)}JIRA.bind(JIRA.Events.NEW_CONTENT_ADDED,function(e,$ctx){initGallery($("a.gallery",$ctx));$("a.issueaction-viewworkflow",$ctx).each(function(){var title=$(this).attr("rel");if(title){title=AJS.escapeHTML(title)}$(this).fancybox({type:"image",href:this.href,title:title,titlePosition:"outside",imageScale:true,centerOnScroll:true,overlayShadow:true})})})})(AJS.$);
(function($){var preventEscClosingComments=false;var commentForm={setCaretAtEndOfCommentField:function(){var $field=this.getField(),field=$field[0],length;if($field.length){length=$field.val().length;$field.scrollTop($field.attr("scrollHeight"));if(field.setSelectionRange&&length>0){field.setSelectionRange(length,length)}}},disable:function(){this.getForm().find("textarea").attr("readonly","readonly");this.getForm().find(":submit").attr("disabled","disabled")},isDirty:function(){var form=this.getForm();if(form){var field=this.getField()[0];return field.value!==field.defaultValue}return false},handleBrowseAway:function(){if(commentForm.isDirty()){return "You have entered a comment on this issue. If you navigate away from this page without first saving, the comment will be lost."}},setSubmitState:function(){if(jQuery.trim(this.getField().val()).length>0){this.getForm().find(":submit").removeAttr("disabled")}else{this.getForm().find(":submit").attr("disabled","disabled")}},enable:function(){this.getForm().find("textarea").removeAttr("readonly");this.getForm().find(":submit").removeAttr("disabled")},ajaxSubmit:function(callback){var issueId=JIRA.Issue.getIssueId();this.getForm().ajaxSubmit({data:{inline:true,decorator:"dialog",ignoreRedirect:true},success:function(data){if(data!==""){new JIRA.FormDialog({content:$(data)}).show();commentForm.enable()}else{JIRA.trigger(JIRA.Events.UNLOCK_PANEL_REFRESHING,["addcommentmodule"]);JIRA.trigger(JIRA.Events.REFRESH_ISSUE_PAGE,[issueId,{complete:function(){if(callback){callback()}}}])}}})},getForm:function(){var $form=$("form#issue-comment-add");if($form.length===1){this.$form=$form}return this.$form},getField:function(){var $form=this.getForm();return this.getForm().find("#comment")},hide:function(cancel){this.getForm().detach();if(JIRA.Events.UNLOCK_PANEL_REFRESHING){JIRA.trigger(JIRA.Events.UNLOCK_PANEL_REFRESHING,["addcommentmodule"])}if(cancel){this.cancel()}},show:function(){this.focus();if(JIRA.Events.LOCK_PANEL_REFRESHING){JIRA.trigger(JIRA.Events.LOCK_PANEL_REFRESHING,["addcommentmodule"])}},focus:function(){this.getField().focus().trigger("keyup");this.setCaretAtEndOfCommentField()},showNoCommentMsg:function(e){if(this.getField().val()===""){$("#emptyCommentErrMsg").show();return true}},cancel:function(){var instance=this;setTimeout(function(){instance.getField().val("")},100);$("#comment-preview_link.selected").click()}};var footerComment={getModule:function(){return $("#addcomment")},isActive:function(){return this.getModule().hasClass("active")},hide:function(cancel){if(this.isActive()){this.getModule().removeClass("active");commentForm.hide(cancel)}},ajaxSubmit:function(){commentForm.ajaxSubmit(function(){footerComment.hide()})},show:function(){if(!this.isActive()){commentDrawer.hide();this.getModule().addClass("active");this.appendForm();commentForm.show()}},appendForm:function(){this.getModule().find(".mod-content").append(commentForm.getForm())}};var commentDrawer={getTrigger:function(){return $("#comment-issue")},appendForm:function(){$(".ops-cont").append(commentForm.getForm())},ajaxSubmit:function(){commentForm.ajaxSubmit(function(){commentDrawer.hide()})},isActive:function(){return this.getTrigger().hasClass("active")},hide:function(cancel){if(this.isActive()){this.getTrigger().removeClass("active");commentForm.hide(cancel);JIRA.Issue.getStalker().removeClass("action").trigger("stalkerHeightUpdated")}},show:function(){if(!this.isActive()){footerComment.hide();this.getTrigger().addClass("active");this.appendForm();commentForm.show();JIRA.Issue.getStalker().addClass("action").trigger("stalkerHeightUpdated")}},toggle:function(){if(this.isActive()){this.hide()}else{this.show()}}};var oldBeforeUnload=window.onbeforeunload;$(document).delegate("body:not(.ka) #issue-comment-add","submit",function(e){window.onbeforeunload=oldBeforeUnload}).delegate(".ka .issue-header #issue-comment-add","submit",function(e){commentDrawer.ajaxSubmit();e.preventDefault()}).delegate(".ka #addcomment #issue-comment-add","submit",function(e){footerComment.ajaxSubmit();e.preventDefault()}).delegate(".issue-header #comment-issue","click",function(e){commentDrawer.toggle();e.preventDefault()}).delegate("#issue-comment-add .cancel","click",function(e){e.preventDefault();commentDrawer.hide(true)}).delegate("#footer-comment-button","click",function(e){footerComment.show();e.preventDefault()}).delegate("#addcomment .cancel","click",function(e){e.preventDefault();footerComment.hide(true)}).delegate("#issue-comment-add","submit",function(){window.setTimeout(function(){commentForm.disable()},0)}).delegate("#issue-comment-add #comment","txtinput",function(){commentForm.setSubmitState()}).delegate("#issue-comment-add input[type='submit']","click",function(e){if(commentForm.showNoCommentMsg()){e.preventDefault()}}).bind("showWikiInput",function(){var $commentField=commentForm.getField();if($commentField.is(":visible:enabled")){JIRA.Issue.getStalker().trigger("stalkerHeightUpdated");if($commentField.length>0){$commentField.focus()}}}).bind("showWikiInput",function(){commentForm.setCaretAtEndOfCommentField()}).bind("showWikiPreview",function(){JIRA.Issue.getStalker().trigger("stalkerHeightUpdated")}).bind("keydown",function(e){if(e.keyCode===$.ui.keyCode.ESCAPE&&AJS.InlineLayer.current){preventEscClosingComments=true;$(document).one("Mention.afterHide",function(e){preventEscClosingComments=false})}if(e.keyCode===$.ui.keyCode.ESCAPE&&!AJS.InlineLayer.current&&!preventEscClosingComments){commentDrawer.hide()}});window.onbeforeunload=function(){return oldBeforeUnload.apply(this,arguments)||commentForm.handleBrowseAway.apply(this,arguments)};$(function(){new AJS.SecurityLevelSelect($("#commentLevel"))})})(AJS.$);
(function($){var activateTab=function(tabNum){$("#customfield-tabs li.active").removeClass("active");$("#tabCell"+tabNum).addClass("active");$("#customfieldmodule ul.property-list:not(hidden)").addClass("hidden");var $tabPane=$("#tabCellPane"+tabNum);$tabPane.removeClass("hidden").trigger("tabSelect",{pane:$tabPane})};$(document).delegate("#customfield-tabs li a","click",function(e){e.preventDefault();var $this=AJS.$(this);activateTab($this.attr("rel"))});$(function(){var revealer=function(e){var tabNum=$(e.target).parents(".pl-tab").attr("id").substring("tabCellPane".length);activateTab(tabNum)};if(JIRA.Events.PANEL_REFRESHED){JIRA.bind(JIRA.Events.PANEL_REFRESHED,function(e,panel,$new,$existing){if(panel==="details-module"){var $activeTab=$existing.find("#customfield-tabs li.active");if($activeTab.length===1){$new.find("#"+$activeTab.attr("id")+" a").click()}}$("#customfieldmodule").unbind("reveal");$("#customfieldmodule").bind("reveal",revealer)})}$("#customfieldmodule").bind("reveal",revealer)})})(AJS.$);
(function($){$(document).delegate("#tt_include_subtasks input","click",function(e){if(AJS.$(this).is(":checked")){AJS.$("#tt_info_single").hide();AJS.$("#tt_info_aggregate").show()}else{AJS.$("#tt_info_aggregate").hide();AJS.$("#tt_info_single").show()}})})(AJS.$);
